### AI_Agent — 基于 LangGraph 的轻量级 RAG 与赛题9智能体方案草案

本项目展示了一个基于 LangChain/LangGraph 构建的极简 RAG 原型（见 `easy_rag.py`），并给出面向“赛题9：基于LLM的账务智能体-财枢智擎”的落地扩展方案与实现路线。

---

### 快速开始

- **环境要求**
  - Python `>=3.11`
  - 可用的 OpenAI 接口兼容推理服务（例如本地部署的 OpenAI-Compatible HTTP API）
  - Windows PowerShell 或类似终端

- **安装依赖**
  - 使用 `uv`（推荐）：
    ```bash
    uv sync
    ```
  - 或使用 `pip`：
    ```bash
    pip install -e .
    ```

- **运行 Demo**
  ```bash
  python easy_rag.py
  ```
  脚本会加载 3 篇博客文章，构建内存向量库，基于 LangGraph 的工具调用实现“是否检索→检索→生成答案”的最小可用工作流。

---

### 配置说明（OpenAI 兼容端点）

- 如果你使用本地推理服务（如 vLLM/Ollama/OpenAI-Proxy），请确保：
  - `base_url` 指向你的 HTTP 接口（例：`http://localhost:18888/v1`）
  - `model` 名称与后端一致
  - `api_key` 若不校验可随意填；若需要校验请设置环境变量 `OPENAI_API_KEY`，并删除脚本内硬编码

---

### 赛题9 目标与技术任务的落地方案

- **总体目标**：构建一套对账务数据特征进行适配的 LLM 智能体，支持术语问答、多层检索与总分不平问题定位分析。

#### ① 账务知识库与术语问答（知识获取与构建）
- **数据来源与构建**：
  - 输入数据为结构化纯文本（CSV/TSV/Parquet 可转文本），包括：分户余额（约2亿）、会计分录（约1亿）、交易明细（约700万）、总分核对结果（约60万），时间区间 2025-06-01 至 2025-06-10。
  - 设计多索引向量库：
    - 账务术语库（手册/规章/口径文档 → Text Embedding）
    - 账务实体库（科目/账号/机构/币种/日期 → 结构化键 + 说明性文本）
    - 分录/交易/核对结果的“摘要视图”（行级摘要 + 键字段拼接为可检索文本）
- **实现建议**：
  - `loaders`: 文件分片增量导入（支持每日增量）
  - `splitters`: 针对术语/制度文档使用语义切分；针对结构化数据构造“拼装文本”
  - `vectorstores`: 先用内存向量库做小样验证，再迁移到 `pgvector`/`FAISS`/`Milvus`
  - `tools`: 构建“术语检索工具”“实体说明检索工具”“行级摘要检索工具”
  - `agent`: 优先通过工具检索，限制 LLM 直接生成，降低幻觉
  - 输出：精准解释账务体系基础构成、关键术语概念与作用；支持新员工的交互式学习问答

#### ② 长对话记忆与干扰过滤（业务意图可持续跟踪）
- **记忆强化**：
  - 使用 LangGraph 状态机 + 记忆节点（会话摘要、实体记忆、意图轨迹）
  - “注意力加权摘要”：对历史轮次进行评分（基于关键词/实体/时间），保留高权重关键信息，动态刷新会话上下文
- **干扰过滤**：
  - 在对话入口添加“业务意图识别器”+“闲聊/噪声过滤器”，对不相关内容降权或丢弃，只将与账务相关的信息喂给 LLM
- **实现建议**：
  - `tools`: 实体抽取、关键词打分器、会话摘要器
  - `graph`: `入口→意图识别/过滤→工具检索→决策→回答生成→记忆更新`
  - 目标：20+轮对话信息不衰减，能稳定获取多维度信息（科目、机构、日期、币种、金额等）

#### ③ 总分不平定位与因果推理（推理与决策）
- **任务拆解**：
  - 输入：总分不平科目
  - 步骤：
    - 检索对应日期/机构/币种/金额（从总分核对结果中提取）
    - 追溯上游发生明细（关联会计分录/交易明细），构建因果链条
    - 结合核对异常模式库，输出可能原因（如跨系统延迟、币种转换、冲销失败、记账口径差异等）与证据数据
- **实现建议**：
  - `tools`: 
    - 条件检索器（按科目/日期/机构/币种/金额过滤）
    - 明细追溯器（由核对结果→分录→交易链）
    - 模式匹配器（基于异常模式规则/少量示例微调）
  - `graph` 决策：
    - 先判定信息完备度（若不全→追问用户补充）
    - 若完备→按“核对结果→分录→交易明细”层层钻取
    - 汇总证据，输出原因 Top-K + 置信度/证据片段

---

### 面向超大规模数据的工程化建议

- **数据分层**：冷热分离，近时段数据走向量 + 结构化二级索引，历史归档以检索器透传 DB/数据湖
- **存储**：向量库建议用 `pgvector`/`Milvus`；结构化查询通过 `PostgreSQL`/`DuckDB`/`ClickHouse`
- **索引**：对 `科目/账号/机构/币种/日期` 组合键建立倒排或联合索引；对文本摘要建立向量索引
- **吞吐**：通过服务化工具节点（微服务/函数计算）并发执行检索与聚合
- **治理**：标注异常模式与问答对，定期校准提示词与规则，离线评估 + 在线 A/B

---

### 拓展项目结构（建议）

- `src/agents/accounting_agent/`
  - `graph.py`：主工作流（意图识别→过滤→多层检索→推理→回答→记忆）
  - `tools/`
    - `term_retriever.py`、`entity_retriever.py`、`ledger_tracer.py`、`anomaly_patterns.py`
  - `memory/`
    - `summarizer.py`、`attention_buffer.py`、`entity_memory.py`
  - `data_ingest/`
    - `loader_csv.py`、`builder_vector.py`、`builder_relational.py`
  - `prompts/`：系统提示词与风格对齐
  - `eval/`：术语准确率、检索召回率、异常定位命中率、对话持久度

---

### 与现有 Demo 的衔接路线

- 在 `easy_rag.py` 的工作流基础上逐步替换：
  - 将 `InMemoryVectorStore` 替换为持久化向量库
  - 增加结构化检索工具（SQL/数据湖查询）
  - 增加“意图识别/过滤/记忆更新”节点
  - 增加“异常定位”多步工具链与决策边
- 在 `main.py` 中提供 CLI 接口，支持以下命令：
  - `--mode qa-term`：术语问答
  - `--mode multi-retrieval`：多层检索问答
  - `--mode diagnose`：总分不平定位与因果分析
  - `--date/--org/--subject/--ccy/--amount`：条件过滤

---

### 基础命令与开发脚手架

- 运行最小 Demo：
  ```bash
  python easy_rag.py
  ```
- 运行主入口：
  ```bash
  python -m ai-agent
  ```
  目前 `main.py` 仅输出欢迎语，可按上文扩展 CLI 模式。

---

### 路线图（Roadmap）

- [ ] 构建账务术语与制度向量索引（支持语义解释）
- [ ] 结构化数据导入与“行级摘要视图”构建
- [ ] 多检索器组合（术语/实体/明细/核对结果）与工具封装
- [ ] 会话记忆与注意力加权摘要、干扰过滤
- [ ] 总分不平追溯与异常模式库（规则 + 示例）
- [ ] 评估指标与对齐优化（减少幻觉、提升证据引用）
- [ ] 服务化部署与并发优化（数据量级适配）

