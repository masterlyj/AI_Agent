# 思考推理过程 v2.2 - 详细信息展示

## 🎯 新特性概述

从 v2.2.0 版本开始，AI的思考推理过程不再是简单的几个字，而是包含**实际的系统执行信息**，让用户清楚地看到AI如何分析问题。

## 📊 思考过程包含的信息

### 1. 检索统计
```
• 检索到 5 个相关实体
• 检索到 3 条相关关系
• 检索到 3 个相关文档片段
```

### 2. 关键实体列表（前5个）
```
• 保险豁免 (概念)
• 保费豁免 (条款)
• 投保人 (角色)
• 被保险人 (角色)
• 保险合同 (文档)
```

### 3. 关系三元组（前3个）
```
• 保险豁免 → 适用于 → 特定情况
• 投保人 → 享有 → 保费豁免权利
• 保险公司 → 承担 → 豁免责任
```

### 4. 精排文档来源（前3个）
```
• 文档 1: 111002_tk.md (置信度: 0.95)
• 文档 2: 111005_flbe.md (置信度: 0.87)
• 文档 3: 111010_tk.md (置信度: 0.82)
```

## 💬 思考过程示例

**用户提问：** "什么情况下可以申请保费豁免？"

**AI思考过程（在聊天框中显示）：**

```
🧠 正在思考...

我首先理解用户询问的是保费豁免的申请条件。

从系统检索结果来看，我发现了以下相关信息：

1. 检索阶段：
   - 检索到 7 个相关实体
   - 检索到 5 条相关关系
   - 检索到 4 个相关文档片段

2. 关键实体：
   - 保费豁免 (条款)
   - 重大疾病 (概念)
   - 全残 (概念)
   - 身故 (概念)
   - 豁免条件 (规则)

3. 重要关系：
   - 重大疾病 → 触发 → 保费豁免
   - 全残 → 符合 → 豁免条件
   - 投保人 → 可申请 → 保费豁免

4. 文档来源：
   - 文档 1: 111002_tk.md (置信度: 0.93) - 包含详细的豁免条款
   - 文档 2: 111005_flbe.md (置信度: 0.88) - 提到重疾豁免
   - 文档 3: 111013_tk.md (置信度: 0.85) - 说明豁免程序

基于这些检索信息，我发现保费豁免主要适用于三种情况：重大疾病、
全残和身故。从文档1中可以看到详细的豁免条件，包括疾病类型、
诊断标准和申请流程。关系图谱显示这三种情况都会触发豁免机制。

因此，我将结合这些实体、关系和文档内容，详细说明保费豁免的
申请条件和具体情形。
```

**然后思考过程消失，被答案替换：**

```
保费豁免通常适用于以下三种情况：

1. 重大疾病：投保人罹患合同约定的重大疾病...
2. 全残：投保人因意外或疾病导致完全丧失劳动能力...
3. 身故：投保人不幸身故...

[答案继续...]
```

## 🔧 实现原理

### 提示词设计
```python
# 系统提示词要求LLM：
1. 使用第一人称（"我首先..."、"我发现..."）
2. 详细描述不少于150字
3. 明确提及检索到的实体、关系和文档
4. 按5个步骤思考：问题理解、检索过程、信息筛选、推理分析、结论形成
```

### 数据注入
```python
# 用户提示词包含：
- 实际检索到的实体列表（前5个，含类型）
- 关系三元组（前3个）
- 精排文档（前3个，含来源和置信度）
- 检索统计数字
```

## 📈 效果对比

### v2.1 版本（之前）
```
🧠 正在思考...

理解问题，分析上下文，推导答案。
```
**问题**：太简短，看不出系统做了什么

### v2.2 版本（现在）
```
🧠 正在思考...

我首先理解用户询问的是保费豁免的申请条件。

从系统检索结果来看，我发现了以下相关信息：
• 检索到 7 个相关实体：保费豁免(条款)、重大疾病(概念)...
• 检索到 5 条关系：重大疾病 → 触发 → 保费豁免...
• 检索到 4 个文档，置信度最高的来自 111002_tk.md

基于这些信息，我发现保费豁免主要适用于三种情况...
[详细的推理过程]
```
**优势**：
- ✅ 展示实际检索信息
- ✅ 显示推理逻辑
- ✅ 增强透明度和信任感
- ✅ 帮助用户理解系统工作方式

## 🎨 显示特点

1. **实时流式显示**：思考过程逐字生成，像打字机一样
2. **自动替换**：答案开始生成时，思考过程自动消失
3. **清晰标记**：使用 🧠 图标和"正在思考..."标题
4. **结构化展示**：分段显示检索信息、推理过程等

## 🚀 使用建议

1. **复杂问题更有效**：对于简单问题，思考过程可能较短
2. **查看终端日志**：可以看到更详细的系统执行信息
3. **理解AI逻辑**：通过思考过程了解AI如何分析问题
4. **发现问题**：如果答案不准确，可以通过思考过程判断是检索问题还是推理问题

## 🔍 调试提示

如果思考过程显示不正常：

1. **检查终端日志**：查找 `💭 思考推理进度` 日志
2. **运行测试脚本**：`python test_reasoning.py`
3. **确认LLM配置**：确保模型支持流式输出
4. **参考调试指南**：查看 `REASONING_DEBUG_GUIDE.md`

## 📝 技术细节

- **字数要求**：不少于150字
- **实体展示**：最多5个，包含名称和类型
- **关系展示**：最多3个三元组
- **文档展示**：最多3个，包含来源和置信度
- **生成方式**：使用LLM流式API (`llm.astream()`)
- **显示位置**：聊天框内，答案生成时自动替换

---

**版本**: v2.2.0  
**更新日期**: 2025-11-07  
**作者**: AI Agent Team

